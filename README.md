# vulnerability-scan-3-13-3-14
Full CI-CD deployment

### Steps to do!

-see Coaching.pptx

-    git clone <repository ssh>
-    npm init * right after git clone
-    npm install serverless * don't need this?
-    npm install serverless-offline –save-dev * i think is after putting index.js and serverless.yml without the environment in serverless.yml yet
-    serverless deploy #to deploy serverless application *check that lambda is added under your service name
-    serverless remove #to remove serverless application on lambda
-    .gitignore (add node_modules/ and .serverless)


**Create workflow “.github/workflows/main.yml” in repo**

name: CICD for Serverless Application
run-name: ${{ github.actor }} is doing CICD for serverless application
``````
on:
  push:
    branches: [ main, "*" ]

jobs:
  pre-deploy:
    runs-on: ubuntu-latest
    steps:
      - run: echo "The job is automatically triggered by a ${{ github.event_name }} event."
``````

**- after this code in main.yml - the github action will have to be done for deploy.**

_________________________

next have to add the block below for main.yml
``````
  install-dependencies:
    runs-on: ubuntu-latest
    needs: pre-deploy
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Run installation of dependencies commands
        run: npm install
``````


**I will have to ensure that the workflow is deploy ok, as format for .yml is very important**
_________________________

FYI only

The --save-dev option in the npm install command is used to save packages under the devDependencies object in your package.json file. This is useful when you have some packages that are needed only for development and testing purposes123.

_________________________

**Now install Jest for unit testing**

npm install jest –save-dev

- told to change package.json 

original msg when Jest is downloaded:
````
 "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
````

to change to :
````
 "scripts": {
    "test": "jest"
  },
````

- told to change the index.test.js message (to be the same as index.js)
original code is:
````
        {
          message: "Go Serverless v3.0! Your function executed successfully!"
        },
````

to change to :

````
        {
          message: "Your function executed successfully!",
        },
````



_________________________

**Adding variables/secrets**

- serverless.yml to add code below to the functions, same line as api: 
chen-string is my parameter store variable name, anyone can refer to this variable
see the environment:
````
functions:
  api:
    handler: index.handler
    events:
      - httpApi:
          path: /
          method: get
    environment:
      ACCESS_INFORMATION: '34234'
      ACCESS_KEY: ${ssm:chen-string}
````

access information: is a manually created 
but the ACCESS_KEY: is for getting the variable from aws parameter store



- index.js add the variable the access key line only to the message  (did not add access_information as I don't need it now, it's an example only)

```
        {
          message: "Your function executed successfully!",
          access_key: process.env.ACCESS_KEY
        },
```
_________________________


AWS's secret manager's recommended to use the code below:

Code from Secret Manager as javascript (add it into index.js is not correct):

```
// Use this code snippet in your app.
// If you need more information about configurations or implementing the sample code, visit the AWS docs:
// https://docs.aws.amazon.com/sdk-for-javascript/v3/developer-guide/getting-started.html

import {
  SecretsManagerClient,
  GetSecretValueCommand,
} from "@aws-sdk/client-secrets-manager";

const secret_name = "enchensecret";

const client = new SecretsManagerClient({
  region: "ap-southeast-1",
});

let response;

try {
  response = await client.send(
    new GetSecretValueCommand({
      SecretId: secret_name,
      VersionStage: "AWSCURRENT", // VersionStage defaults to AWSCURRENT if unspecified
    })
  );
} catch (error) {
  // For a list of exceptions thrown, see
  // https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html
  throw error;
}

const secret = response.SecretString;

// Your code goes here
```

## **Instead use the code below for secret manager's secret retrival, to add to main.yml under deploy:**

      - name: Retrieve secret from AWS parameters store
        uses: aws-actions/aws-secretsmanager-get-secrets@v1
        with:
          secret-ids: |
            enchensecret*
        env:
          AWS_REGION: ap-southeast-1
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: Show My Secrets
        run: |
          for var in $(env | grep '^enchensecret'); do
            echo "Variable: $var"
          done


_________________________

## **add package scanning - to check vulnerabilities to include before deployment (as part of CI)**

```
  package-scan:
    runs-on: ubuntu-latest
    needs: unit-testing
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Run installation of dependencies commands
        run: npm install
      - name: Run audit
        run: npm audit
```

- then also remember to change the `needs:` in deploy block to package-scan so it scans before deploying

```
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: package-scan
    
```